<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transações - Finanza Desktop</title>
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/dashboard.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='50' fill='%23667eea'/><text x='50' y='60' text-anchor='middle' fill='white' font-size='40' font-weight='bold'>F</text></svg>">
    <!-- Firebase SDK compat -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="app-container">
        <div id="sidebar"></div>
        <div class="main-content">
            <!-- REMOVIDO O HEADER -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Transações</h2>
                    <button class="btn btn-primary" onclick="showCreateTransactionModal()">
                        Nova Transação
                    </button>
                </div>
                <div id="transactionsList">
                    <div class="loading"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for creating/editing transactions -->
    <div id="transactionModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Nova Transação</h3>
                <button class="modal-close" onclick="closeTransactionModal()">&times;</button>
            </div>
            <form id="transactionForm">
                <div class="form-group">
                    <label for="transactionDescription" class="form-label">Descrição</label>
                    <input type="text" id="transactionDescription" class="form-input" required>
                </div>
                <div class="form-group">
                    <label for="transactionAmount" class="form-label">Valor</label>
                    <input type="number" id="transactionAmount" class="form-input" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="transactionType" class="form-label">Tipo</label>
                    <select id="transactionType" class="form-input" required>
                        <option value="">Selecione o tipo</option>
                        <option value="receita">Receita</option>
                        <option value="despesa">Despesa</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionAccount" class="form-label">Conta</label>
                    <select id="transactionAccount" class="form-input" required>
                        <option value="">Selecione a conta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionCategory" class="form-label">Categoria</label>
                    <select id="transactionCategory" class="form-input" required>
                        <option value="">Selecione a categoria</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="transactionDate" class="form-label">Data</label>
                    <input type="date" id="transactionDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <button type="submit" class="btn btn-primary">Salvar</button>
                    <button type="button" class="btn btn-secondary ml-2" onclick="closeTransactionModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuração Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAtmg3jhdlvF_GJmfLRt_bHCGRw_nWSMCo",
            authDomain: "finanza-2cd68.firebaseapp.com",
            databaseURL: "https://finanza-2cd68-default-rtdb.firebaseio.com",
            projectId: "finanza-2cd68",
            storageBucket: "finanza-2cd68.appspot.com",
            messagingSenderId: "991299806624",
            appId: "1:991299806624:web:12782bf4a0ab6ed52630c5",
            measurementId: "G-M1TCD97PRW"
        };
        firebase.initializeApp(firebaseConfig);

        const adminEmails = ["admin@finanza.com", "seu_email_admin@dominio.com"];
        function generateSidebar(user) {
            const isAdmin = user && adminEmails.includes(user.email);
            return `
                <div class="sidebar">
                    <div class="sidebar-logo">
                        <img src="../IMAGENS/logo.png" alt="Logo Finanza" class="logo-small" />
                        <h2>Finanza</h2>
                    </div>
                    <div class="sidebar-user mb-4">
                        <span>${user?.email || 'Usuário'}</span>
                    </div>
                    <ul class="nav-menu">
                        <li class="nav-item"><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                        <li class="nav-item"><a href="accounts.html" class="nav-link">Contas</a></li>
                        <li class="nav-item"><a href="transactions.html" class="nav-link active">Transações</a></li>
                        <li class="nav-item"><a href="categories.html" class="nav-link">Categorias</a></li>
                        <li class="nav-item"><a href="profile.html" class="nav-link">Perfil</a></li>
                        ${isAdmin ? `<li class="nav-item"><a href="admin.html" class="nav-link">Admin</a></li>` : ""}
                        <li class="nav-item"><a href="#" class="nav-link" id="logoutBtn">Sair</a></li>
                    </ul>
                </div>
            `;
        }

        // Utils
        function formatCurrency(value) {
            return "R$ " + Number(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
        }

        let currentUser = null;
        let editingTransactionId = null;
        let contas = [];
        let categorias = [];

        document.addEventListener('DOMContentLoaded', function () {
            firebase.auth().onAuthStateChanged(function(user) {
                if (!user) {
                    window.location.href = "login.html";
                    return;
                }
                currentUser = user;
                document.getElementById('sidebar').innerHTML = generateSidebar(user);

                document.getElementById('logoutBtn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    await firebase.auth().signOut();
                    window.location.href = "login.html";
                });

                loadContas();
                loadCategorias();
                loadTransactions();

                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            });
        });

        function loadContas() {
            firebase.database().ref('contas/' + currentUser.uid).on('value', snapshot => {
                contas = [];
                const select = document.getElementById('transactionAccount');
                select.innerHTML = '<option value="">Selecione a conta</option>';
                snapshot.forEach(child => {
                    contas.push({ id: child.key, ...child.val() });
                    select.innerHTML += `<option value="${child.key}">${child.val().nome}</option>`;
                });
            });
        }

        function loadCategorias() {
            firebase.database().ref('categorias/' + currentUser.uid).on('value', snapshot => {
                categorias = [];
                const select = document.getElementById('transactionCategory');
                select.innerHTML = '<option value="">Selecione a categoria</option>';
                snapshot.forEach(child => {
                    categorias.push({ id: child.key, ...child.val() });
                    select.innerHTML += `<option value="${child.key}">${child.val().nome}</option>`;
                });
            });
        }

        function loadTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            transactionsList.innerHTML = `<div class="loading"></div>`;
            firebase.database().ref('transacoes/' + currentUser.uid).on('value', snapshot => {
                const transacoes = [];
                snapshot.forEach(child => {
                    transacoes.push({ id: child.key, ...child.val() });
                });
                if (transacoes.length === 0) {
                    transactionsList.innerHTML = `<p class="text-center">Nenhuma transação encontrada.</p>`;
                    return;
                }
                const html = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Descrição</th>
                                <th>Valor</th>
                                <th>Tipo</th>
                                <th>Conta</th>
                                <th>Categoria</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${transacoes.map(transaction => {
                                const conta = contas.find(c => c.id === transaction.conta_id);
                                const categoria = categorias.find(cat => cat.id === transaction.categoria_id);
                                return `
                                    <tr>
                                        <td>${transaction.data ? new Date(transaction.data).toLocaleDateString('pt-BR') : '-'}</td>
                                        <td>${transaction.descricao || '-'}</td>
                                        <td style="color: ${transaction.tipo === 'receita' ? '#48bb78' : '#f56565'};">
                                            ${formatCurrency(transaction.valor)}
                                        </td>
                                        <td>
                                            <span style="color: ${transaction.tipo === 'receita' ? '#48bb78' : '#f56565'};">
                                                ${transaction.tipo === 'receita' ? 'Receita' : 'Despesa'}
                                            </span>
                                        </td>
                                        <td>${conta ? conta.nome : '-'}</td>
                                        <td>${categoria ? categoria.nome : '-'}</td>
                                        <td>
                                            <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.5rem;" onclick="editTransaction('${transaction.id}')">Editar</button>
                                            <button class="btn btn-danger ml-1" style="font-size: 0.8rem; padding: 0.5rem;" onclick="deleteTransaction('${transaction.id}')">Excluir</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
                transactionsList.innerHTML = html;
            });
        }

        function showCreateTransactionModal() {
            editingTransactionId = null;
            document.getElementById('modalTitle').textContent = 'Nova Transação';
            document.getElementById('transactionForm').reset();
            document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('transactionModal').classList.remove('hidden');
        }
        window.showCreateTransactionModal = showCreateTransactionModal;

        function closeTransactionModal() {
            document.getElementById('transactionModal').classList.add('hidden');
            editingTransactionId = null;
        }
        window.closeTransactionModal = closeTransactionModal;

        function editTransaction(transactionId) {
            firebase.database().ref('transacoes/' + currentUser.uid + '/' + transactionId).once('value')
                .then(snapshot => {
                    const transaction = snapshot.val();
                    if (transaction) {
                        editingTransactionId = transactionId;
                        document.getElementById('modalTitle').textContent = 'Editar Transação';
                        document.getElementById('transactionDescription').value = transaction.descricao;
                        document.getElementById('transactionAmount').value = transaction.valor;
                        document.getElementById('transactionType').value = transaction.tipo;
                        document.getElementById('transactionAccount').value = transaction.conta_id;
                        document.getElementById('transactionCategory').value = transaction.categoria_id;
                        document.getElementById('transactionDate').value = transaction.data ? transaction.data.split('T')[0] : '';
                        document.getElementById('transactionModal').classList.remove('hidden');
                    }
                });
        }
        window.editTransaction = editTransaction;

        function deleteTransaction(transactionId) {
            if (confirm('Tem certeza que deseja excluir esta transação?')) {
                firebase.database().ref('transacoes/' + currentUser.uid + '/' + transactionId).remove();
            }
        }
        window.deleteTransaction = deleteTransaction;

        document.getElementById('transactionForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const descricao = document.getElementById('transactionDescription').value;
            const valor = parseFloat(document.getElementById('transactionAmount').value);
            const tipo = document.getElementById('transactionType').value;
            const conta_id = document.getElementById('transactionAccount').value;
            const categoria_id = document.getElementById('transactionCategory').value;
            const data = document.getElementById('transactionDate').value;

            const transactionData = {
                descricao, valor, tipo, conta_id, categoria_id, data
            };

            if (editingTransactionId) {
                firebase.database().ref('transacoes/' + currentUser.uid + '/' + editingTransactionId).update(transactionData)
                    .then(() => {
                        closeTransactionModal();
                    });
            } else {
                firebase.database().ref('transacoes/' + currentUser.uid).push(transactionData)
                    .then(() => {
                        closeTransactionModal();
                    });
            }
        });
    </script>
</body>
</html>